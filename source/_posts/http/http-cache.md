---
title: Http中的缓存（一） 强缓存、协商缓存 缓存
date: 2018-09-07 10:29:23
tags: [Http]
categories: [Http]
description: http中的缓存、强缓存、协商缓存
---
> [Http中的缓存（一） 多级缓存结构](/blog/http/http-cache.html)
> [Http中的缓存（二） HTTP中的缓存](/blog/http/http-etag-cache.html)
> [Http中的缓存（三） PWA中的ServiceWorker](/blog/http/http-cache-serviceworker.html)

## 简介

**缓存**相信现在这个词大家都不陌生，因为在当前的应用中被广泛的应用。因为**缓存**会带来更高的**性能**、**用户体验**，同时也会**节省流量**、**离线体验**等等好处。

关于缓存的文章分为三篇：**多级缓存结构**、**HTTP缓存详解**、**离线缓存**

### 缓存的分层

**缓存**大致分为如下：

- **客户端/浏览器缓存**
- **http/服务器缓存**
- **cdn缓存**
- **代理服务器缓存**
- **后端进程缓存redis、lru等等**
- **分布式缓存**
- **数据库**

可以在下面几层做缓存大致如下：

<img src="../../images/http/http-cache-1-1.png" height="300" alt="http-cache"/>

### 多层缓存流程

整个的缓存判断流程是：

1. **用户刷新页面发出请求**
2. 客户端/浏览器是否命中`serviceWorker`、**强缓存（缓存策略）**、**协商缓存**
3. **cdn缓存**
4. **代理服务器缓存**
5. **进程缓存**
6. **分布式缓存**
7. **数据库**

这里主要记述**客户端/浏览器缓存**、**http/服务器缓存**的一些使用和细节。

## HTTP缓存

`HTTP`缓存基本上可以分为两类： **一类强缓存（有效期策略）**、**另一类 协商缓存（资源唯一标识符）**。它们缓存在不同的位置，按照分类为：**本地硬盘缓存**、**本地内存缓存**。当时对于一些不同的文件类型要用不同的缓存来做，同时让它们缓存在不同的位置。
跟随**移动端**应用的发展，为了提高用户离线的体验，延伸出了不同**离线缓存方案**大致有两种实现方式：**AppCache**、**ServiceWorker**两种方式。

在这里一些详细的实现方式和细节不多做解释，在下片文章[Http中的缓存（二） HTTP中的缓存](/blog/http/http-etag-cache.html)来详细的记录，比如**有限期是怎么验证的**、**详细的配置**、**不同的本地缓存储存在那**、**它们之间的对比和适用缓存文件**等等。

### 强缓存

**强缓存**可以用三种实行方式： `cache-control`、`Expires`、`Pragma`它们都是通过**有效期**来决定是否命中缓存的。

大致的优先级如下： 在本地 `Cache-Control > Expires，Pragma 在不支持 Cache-Control` 时生效。

### 协商缓存

**协商缓存**可以用两种种实行方式： `Last-Modified/If-Modified-Since`、`Etag/If-None-Match`它们的实现方式是不同的。

**Last-Modified/If-Modified-Since**是通过**有限期**来检验是否使用缓存，而**Etag/If-None-Match**它是通过**唯一资源标识符**来判断是否使用缓存。
同时它们的整体流程也是不同，比如说**Last-Modified/If-Modified-Since**返回的**HTTP状态**为**200状态码**，而**Etag/If-None-Match**它返回的是**304状态码**。

### 储存位置

从缓存位置上来看，分为**4种**，**从上往下依次检查**是否命中，如果但都没有命中则重新发起请求。

- `Service Worker` 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能。使用 `Service Worker`的话，传输协议必须为 `HTTPS`。
- `Memory Cache` 也就是**内存**中的缓存，主要包含的是当前中页面中已经抓取到的资源,例如页面上已经下载的样式、脚本、图片等。
- `Disk Cache` 也就是存储在硬盘中的缓存。
- `Push Cache`（推送缓存）是 `HTTP/2` 中的内容，当以上三种缓存都没有命中时，它才会被使用。

它们之间是有优缺点的，比如说静态资源适用于`Memory Cache`。

### 用户操作对缓存的影响

当用户的操作比如**地址栏回车**、**前进回退**、**F5刷新**、**Ctrl+F5强制刷新**等等对缓存的影响。大致如下图所示：

![http-cache](../../images/http/http-cache-1-2.png)

在这里就不细究了不然这篇文章太长了。

## CDN缓存

**CND**的全称是**Content Delivery NetWork**内容分发网络。**HTTP**缓存主要是对一些**客户端/浏览器**中的静态资源和**不长更新的数据**资源。
**CDN**是在**客户端**和**服务器**端加设的一层，可以让**CDN**为应用服务器提供缓存，如果在 **CDN** 上缓存，就不用再请求应用服务器了。并且 **HTTP** 缓存提到的两种策略同样可以在 **CDN**服务器执行。

