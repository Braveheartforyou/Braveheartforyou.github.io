---
title: Http中的缓存（二） HTTP中的缓存
date: 2019-01-15 22:29:16
tags: [Http]
categories: [Http]
description: 因为相对于前端能接触到的缓存基本上还是停留在HTTP缓存和cdn缓存这一层，这里就是记录HTTP缓存的多种实现形式，实现形式之间的优缺点。
---

> [Http中的缓存（一） 多级缓存结构](/blog/http/http-cache.html)
> [Http中的缓存（二） HTTP中的缓存](/blog/http/http-etag-cache.html)
> [Http中的缓存（三） PWA中的ServiceWorker](/blog/http/http-cache-serviceworker.html)

## 简述

**HTTP缓存**相信都不陌生，因为它是在前端性能优化中必不可少的一个环节。在**首次进入或者请求数据**正常传输数据，而当**再次进入或者请求数据**时，可以走本地或者服务器上的缓存，来**节省流量**、**优化性能**、**提高用户体验**、**降低网络负荷**等等。

**web缓存**主要用来缓存**html文件**、**js文件**、**css文件**、**数据**，基本上都是提升**客户端/浏览器**请求到**服务器**之间的速度，当然也可以结合数据压缩如**gzip**、**7z**等等加快响应数据传输。

在整个应用中可以错多层缓存结构这里不多做介绍，因为前面已经大致介绍过了，这里主要介绍和前端比较相关的**HTTP缓存**。

## HTTP缓存

大致分为下面几步来加深对**HTTP中的缓存**理解和应用场景。

1. **必知缓存策略的基础**
2. **缓存的判断策略**
3. **用户操作对缓存策略的影响**
4. **缓存策略的储存**
5. **缓存策略之间的对比**

## 必知缓存策略的基础

大致把协议分为**强缓存（过期策略）**和**协商缓存（协商策略）**两类缓存，可能不太准确只是自己的现在的见解，**浏览器/客户端**通过这两种策略决定使用**缓存中的副本**还是从**服务器**中获取最新的资源。

- **强缓存（过期策略）**：也就是缓存副本有效期。
一个缓存副本必须满足以下任一条件，浏览器会认为它是有效的，足够新的，而直接从缓存中获取副本并渲染：
  - *含有完整的过期时间控制头信息（HTTP协议报头），并且仍在有效期内*
  - *浏览器已经使用过这个缓存副本，并且在一个会话中已经检查过新鲜度*
- **协商缓存（协商策略）**：*服务器返回资源的时候有时在控制头信息带上这个资源的实体标签Etag（Entity Tag），它可以用来作为浏览器再次请求过程的校验标识。如果发现校验标识不匹配，说明资源已经被修改或过期，浏览器需求重新获取资源内容。*

| key | 描述 | 缓存策略 | 首部类型 |
|:----:|:---------:|:----:|:----:|
| Pragma | 指定缓存机制（http 1.0 字段） | 强缓存（过期策略） | 响应首部字段 |
| Cache-COntrol | `Cache-Control` 通用消息头字段，被用于在http请求和响应中，通过指定指令来实现缓存机制。 | 强缓存（过期策略） | 响应/请求首部字段 |
| Expires | `Expires` 响应头包含日期/时间， 即在此时候之后，响应过期。 | 强缓存（过期策略） | 响应首部字段 |
| Last-Modified | `Last-Modified`  是一个响应首部，其中包含源头服务器认定的资源做出修改的日期及时间。 | 协商缓存（协商策略） | 响应首部字段 |
| If-Modified-Since | `If-Modified-Since` 是一个条件式请求首部，服务器只在所请求的资源在给定的日期时间之后对内容进行过修改的情况下才会将资源返回，状态码为 `200`。 | 协商缓存（协商策略） | 请求首部字段 |
| ETag | `ETag`HTTP响应头是资源的特定版本的标识符。 | 协商缓存（协商策略） | 响应首部字段 |
| If-None-Match | `If-None-Match` 是一个条件式请求首部。对于 `GET` 和 `HEAD` 请求方法来说，当且仅当服务器上没有任何资源的 `ETag` 属性值与这个首部中列出的相匹配的时候，服务器端会才返回所请求的资源，响应码为  `200`  。 | 协商缓存（协商策略） | 请求首部字段 |
| If-Match（辅助） | `If-Match` 的使用表示这是一个条件请求。在请求方法为 `GET` 和 `HEAD` 的情况下，服务器仅在请求的资源满足此首部列出的 `ETag`值时才会返回资源。 | 协商缓存（协商策略） | 请求首部字段 |
| If-Unmodified-Since（辅助） | `If-Unmodified-Since` 只有当资源在指定的时间之后没有进行过修改的情况下，服务器才会返回请求的资源，或是接受 `POST` 或其他 `non-safe` 方法的请求。 | 协商缓存（协商策略） | 请求首部字段 |
| Vary（辅助） | `Vary` 是一个`HTTP`响应头部信息，它决定了对于未来的一个请求头，应该用一个缓存的回复(response)还是向源服务器请求一个新的回复。 | 协商缓存（协商策略） | 响应首部字段 |

<!-- 下面四个就多做介绍了，大家可以去**mdn**中观看，下面是mdn中的连接。

- [Pragma](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Pragma)
- [If-Match](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match)
- [If-Unmodified-Since](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since)
- [Vary](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Vary) -->

*缓存又分为**强缓存和弱缓存（又称为协商缓存）**。其中强缓存包括`Expires`和`Cache-Control`，**主要是在过期策略生效时应用的缓存**。弱缓存包括`Last-Modified`和`ETag`，**是在协商策略后应用的缓存**。**强弱缓存之间的主要区别在于获取资源时是否会发送请求**。*

## 强缓存（过期策略）

属于**强缓存（过期策略）**的有如下：

- Cache-COntrol
- Expires

### Cache-Control

`Cache-Control`用于指定资源的缓存机制，可以同时在请求和响应头中设定。
`Cache-Control`: `cache-directive[,cache-directive]`。`cache-directive`为缓存指令，大小写不敏感，共有**12**个与**HTTP**缓存标准相关，如下表所示。其中请求指令*7*种，响应指令*9*种。`Cache-Control`可以设置多个缓存指令，以逗号`,`分隔。

| key | 描述 | 缓存策略 | 首部类型 |
|:----:|:---------:|:----:|:----:|
| Pragma | 指定缓存机制（http 1.0 字段） | 强缓存（过期策略） | 响应首部字段 |